format_version: "11"
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

project_type: flutter

trigger_map:
- push_branch: main
  workflow: primary
- pull_request_target_branch: main
  workflow: primary

workflows:
  primary:
    steps:
    - activate-ssh-key@4:
        run_if: '{{setup_ssh_key}}'
    - git-clone@6: {}
    - flutter-installer@0:
        inputs:
        - is_update: "false"
    - script@1:
        title: "Setup and Build"
        inputs:
        - content: |-
            #!/bin/bash
            set -ex
            
            # Forzar Java 17
            if [ -d "/usr/lib/jvm/java-17-openjdk-amd64" ]; then
                export JAVA_HOME="/usr/lib/jvm/java-17-openjdk-amd64"
            elif [ ! -z "$JAVA_HOME_17_X64" ]; then
                export JAVA_HOME="$JAVA_HOME_17_X64"
            fi
            export PATH=$JAVA_HOME/bin:$PATH
            java -version
            
            # Forzar permisos de ejecución en gradlew
            find . -name "gradlew" -exec chmod +x {} \;
            
            # Crear local.properties dinámicamente para que Gradle no falle
            # Esto es vital para que settings.gradle y build.gradle no exploten
            echo "sdk.dir=$ANDROID_HOME" > android/local.properties
            echo "flutter.sdk=$FLUTTER_ROOT" >> android/local.properties
            echo "flutter.versionCode=1" >> android/local.properties
            echo "flutter.versionName=1.0" >> android/local.properties
            
            # Mostrar para debug
            cat android/local.properties
            
            # Limpiar y build con verbose
            flutter clean
            flutter pub get
            
            # Aceptar licencias manualmente por las dudas
            yes | sdkmanager --licenses || true
            
            # BUILD FINAL
            flutter build apk --debug --verbose --no-pub
    - deploy-to-bitrise-io@2: {}


app:
  envs:
  - opts:
      is_expand: false
    BITRISE_FLUTTER_PROJECT_LOCATION: "."
