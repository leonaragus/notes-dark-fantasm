format_version: "11"
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

project_type: flutter

workflows:
  primary:
    steps:
    - activate-ssh-key@4:
        run_if: '{{setup_ssh_key}}'
    - git-clone@6: {}
    - script@1:
        title: "Check and Set environment"
        inputs:
        - content: |-
            #!/bin/bash
            set -ex
            # Mostrar herramientas instaladas
            echo "Checking environment..."
            env | sort
            
            # Forzar Java 17
            if [ -d "/usr/lib/jvm/java-17-openjdk-amd64" ]; then
                export JAVA_HOME="/usr/lib/jvm/java-17-openjdk-amd64"
            elif [ ! -z "$JAVA_HOME_17_X64" ]; then
                export JAVA_HOME="$JAVA_HOME_17_X64"
            fi
            
            export PATH=$JAVA_HOME/bin:$PATH
            java -version
            
            # Debug Flutter
            flutter --version
    - flutter-installer@0:
        inputs:
        - is_update: "false"
    - script@1:
        title: "Fix permissions and build"
        inputs:
        - content: |-
            #!/bin/bash
            set -ex
            
            # Forzar permisos de ejecuci√≥n en gradlew ANTES de cualquier comando
            find . -name "gradlew" -exec chmod +x {} \;
            
            # Limpiar y forzar dependencias
            flutter clean
            flutter pub get
            
            # Aceptar licencias manualmente
            yes | sdkmanager --licenses || true
            
            # Build manual para ver errores reales en el log de Bitrise
            flutter build apk --debug --verbose --no-pub
    - deploy-to-bitrise-io@2: {}


app:
  envs:
  - opts:
      is_expand: false
    BITRISE_FLUTTER_PROJECT_LOCATION: "."
